<local:BasePage x:Class="Mantra.HandlePage"
                x:ClassModifier="internal"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:local="clr-namespace:Mantra"
                xmlns:componentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
                xmlns:system="clr-namespace:System;assembly=System.Runtime"
                xmlns:core="clr-namespace:Mantra.Core.Models"
                mc:Ignorable="d"
                d:DataContext="{d:DesignInstance local:HandleViewModel}"
                Title="HandlePage"
                d:DesignHeight="450"
                d:DesignWidth="800">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="5*" />
            <ColumnDefinition Width="2*" MinWidth="400" />
        </Grid.ColumnDefinitions>

        <!-- Image Column -->
        <ScrollViewer Grid.Column="0"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Margin="10 30"
                      CanContentScroll="True">
            <Grid SnapsToDevicePixels="True" Margin="10 0">
                <Image
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Stretch="Uniform"
                    Source="{Binding ImgSource}"
                    Width="{Binding ImgPixelWidth}"
                    Height="{Binding ImgPixelHeight}"
                    SnapsToDevicePixels="True" />

                <!-- ImgSource Canvas -->
                <ItemsControl ItemsSource="{Binding BoundingBoxCollection}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <!-- Must set background -->
                            <!-- It turns out that if you do not set a background on a UIElement, the element background will not participate in hit-testing -->
                            <Canvas SnapsToDevicePixels="True"
                                    Background="Transparent"
                                    MouseLeftButtonDown="Canvas_OnMouseDown"
                                    MouseLeftButtonUp="Canvas_OnMouseUp"
                                    MouseMove="Canvas_OnMouseMove" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter" d:DataContext="{d:DesignInstance core:BoundingBox}">
                            <!-- Must set mode is two way, otherwise not update -->
                            <Setter Property="Canvas.Left" Value="{Binding Left, Mode=TwoWay}" />
                            <Setter Property="Canvas.Top" Value="{Binding Top, Mode=TwoWay}" />
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- Must set mode is two way, otherwise not update -->
                            <local:DesignerContainer Resize="True"
                                                     StrokeColor="{Binding Color}"
                                                     Width="{Binding Width}"
                                                     Height="{Binding Height}">

                                <StackPanel SnapsToDevicePixels="True"
                                            Margin="0 0 0 -25"
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Bottom">
                                    <Button Content="X"
                                            Background="Red"
                                            Command="{Binding DataContext.RemoveCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}"
                                            CommandParameter="{Binding}">
                                        <Button.LayoutTransform>
                                            <ScaleTransform ScaleX="1.5" />
                                        </Button.LayoutTransform>
                                    </Button>
                                    <Button Content="识别文字"
                                            Command="{Binding DataContext.SingleOCRCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}"
                                            CommandParameter="{Binding}" />
                                </StackPanel>
                            </local:DesignerContainer>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </ScrollViewer>

        <!-- Tool Column -->
        <ScrollViewer Grid.Column="1"
                      Margin="0 30 10 30"
                      HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Auto"
                      VerticalAlignment="Top"
                      CanContentScroll="True">

            <TabControl Margin="10 0">
                <!-- OCR TabItem -->
                <TabItem Header="文字识别"
                         FontSize="16"
                         DataContext="{Binding SelectedBoundingBox}"
                         d:DataContext="{d:DesignInstance Type=core:BoundingBox}">

                    <StackPanel SnapsToDevicePixels="True" Visibility="{Binding Converter={local:NullableConverter}}">
                        <!-- Original Text -->
                        <Border CornerRadius="5" Background="{StaticResource WhiteSmokeBrush}" Margin="0 0 0 25">
                            <StackPanel SnapsToDevicePixels="True"
                                        Margin="10">
                                <Grid SnapsToDevicePixels="True" Margin="0 0 0 5">
                                    <TextBlock HorizontalAlignment="Left"
                                               VerticalAlignment="Center"
                                               Text="原文"
                                               FontSize="16"
                                               FontWeight="Bold" />

                                    <Button HorizontalAlignment="Right"
                                            Style="{StaticResource QuaternaryFlatButtonStyle}"
                                            Content="去除换行"
                                            ToolTip="清除换行"
                                            Command="{Binding DataContext.RemoveNewLineCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                            CommandParameter="{Binding}" />
                                </Grid>
                                <TextBox AcceptsReturn="True"
                                         BorderThickness="1"
                                         TextWrapping="Wrap"
                                         Tag="请填写原文内容"
                                         Text="{Binding OriginalText}"
                                         FontSize="14" />
                            </StackPanel>
                        </Border>

                        <!-- Translated Text -->
                        <Border CornerRadius="5" Background="{StaticResource WhiteSmokeBrush}" Margin="0 0 0 25">
                            <StackPanel SnapsToDevicePixels="True"
                                        Margin="10">
                                <TextBlock HorizontalAlignment="Left"
                                           VerticalAlignment="Center"
                                           Text="翻译"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           Margin="0 0 0 5" />

                                <Grid SnapsToDevicePixels="True" Margin="0 0 0 5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <ComboBox Grid.Column="0"
                                              HorizontalAlignment="Left"
                                              ToolTip="语言"
                                              Margin="0 0 5 0 ">
                                        <ComboBoxItem Content="简体中文" IsSelected="True" />
                                        <ComboBoxItem Content="日语" />
                                        <ComboBoxItem Content="英语" />
                                    </ComboBox>
                                    <ComboBox Grid.Column="1"
                                              HorizontalAlignment="Left"
                                              ToolTip="翻译引擎"
                                              Margin="0 0 5 0 ">
                                        <ComboBoxItem Content="百度" IsSelected="True" />
                                        <ComboBoxItem Content="谷歌" />
                                        <ComboBoxItem Content="微软" />
                                    </ComboBox>
                                    <Button Grid.Column="2"
                                            HorizontalAlignment="Right"
                                            Style="{StaticResource PrimaryFlatButtonStyle}"
                                            Content="翻译"
                                            ToolTip="翻译"
                                            Command="{Binding DataContext.SingleTranslateCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                            CommandParameter="{Binding}" />
                                </Grid>
                                <TextBox AcceptsReturn="True"
                                         BorderThickness="1"
                                         TextWrapping="Wrap"
                                         Tag="请填写翻译结果"
                                         Text="{Binding TranslatedText}"
                                         FontSize="14" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </TabItem>

                <!-- List TabItem -->
                <TabItem Header="文字列表" FontSize="16">
                    <TabItem.Resources>
                        <CollectionViewSource IsLiveGroupingRequested="True"
                                              IsLiveSortingRequested="True"
                                              x:Key="CollectionViewSource"
                                              Source="{Binding BoundingBoxCollection}">
                            <CollectionViewSource.GroupDescriptions>
                                <PropertyGroupDescription PropertyName="Group" />
                            </CollectionViewSource.GroupDescriptions>
                            <CollectionViewSource.SortDescriptions>
                                <componentModel:SortDescription PropertyName="Group" />
                                <componentModel:SortDescription PropertyName="Sort" />
                            </CollectionViewSource.SortDescriptions>
                            <CollectionViewSource.LiveGroupingProperties>
                                <system:String>Group</system:String>
                            </CollectionViewSource.LiveGroupingProperties>
                            <CollectionViewSource.LiveSortingProperties>
                                <system:String>Sort</system:String>
                            </CollectionViewSource.LiveSortingProperties>
                        </CollectionViewSource>
                    </TabItem.Resources>

                    <!-- ItemsControl -->
                    <ItemsControl ItemsSource="{Binding Source={StaticResource CollectionViewSource}}">
                        <!-- Item Panel -->
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <!-- Item Template -->
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="5"
                                        Background="{StaticResource WhiteSmokeBrush}"
                                        Margin="0 0 0 20"
                                        BorderBrush="{StaticResource DarkBlueBrush}">

                                    <Border.Resources>
                                        <local:BorderThicknessConverter
                                            x:Key="BorderThicknessConverter" />
                                    </Border.Resources>

                                    <Border.BorderThickness>
                                        <MultiBinding Converter="{StaticResource BorderThicknessConverter}">
                                            <Binding Path="DataContext.SelectedBoundingBox"
                                                     RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                            <Binding Path="DataContext"
                                                     RelativeSource="{RelativeSource Mode=Self}" />
                                        </MultiBinding>
                                    </Border.BorderThickness>

                                    <!-- Click Command -->
                                    <Border.InputBindings>
                                        <MouseBinding Gesture="LeftClick"
                                                      Command="{Binding DataContext.SelectBoundingBoxCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}"
                                                      CommandParameter="{Binding}" />
                                    </Border.InputBindings>

                                    <!-- Content Item -->
                                    <StackPanel SnapsToDevicePixels="True" Margin="10">
                                        
                                        <Grid SnapsToDevicePixels="True" Margin="0 0 0 10">
                                            <!-- Index -->
                                            <TextBlock FontSize="14"
                                                       Foreground="{StaticResource NormalBlueBrush}"
                                                       HorizontalAlignment="Left"
                                                       VerticalAlignment="Center">

                                                <TextBlock.Resources>
                                                    <local:BoundingBoxCollectionIndexConverter
                                                        x:Key="BoundingBoxCollectionIndexConverter" />
                                                </TextBlock.Resources>

                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="# {0}"
                                                                  Converter="{StaticResource BoundingBoxCollectionIndexConverter}">
                                                        <Binding Path="DataContext.BoundingBoxCollection"
                                                                 RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                                        <Binding Path="DataContext"
                                                                 RelativeSource="{RelativeSource Mode=Self}" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                            
                                            <!-- Delete Button -->
                                            <Button SnapsToDevicePixels="True"
                                                    Background="Transparent"
                                                    BorderBrush="Transparent"
                                                    BorderThickness="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Center"
                                                    Command="{Binding DataContext.RemoveCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}"
                                                    CommandParameter="{Binding}">
                                                <Image SnapsToDevicePixels="True"
                                                       Stretch="Fill"
                                                       Width="22"
                                                       Height="22"
                                                       Source="{Binding Source=media/delete.png, Converter={local:FilepathBytesConverter}}"/>
                                            </Button>
                                        </Grid>

                                        <!-- Original Text -->
                                        <TextBlock FontSize="14"
                                                   Text="原文"
                                                   Margin="0 0 0 5" />

                                        <TextBox AcceptsReturn="True"
                                                 BorderThickness="1"
                                                 TextWrapping="Wrap"
                                                 Tag="没有原文"
                                                 Text="{Binding OriginalText}"
                                                 FontSize="14"
                                                 Margin="0 0 0 8"
                                                 IsEnabled="False" />

                                        <!-- Translated Text -->
                                        <TextBlock FontSize="14"
                                                   Text="翻译"
                                                   Margin="0 0 0 5" />
                                        <TextBox AcceptsReturn="True"
                                                 BorderThickness="1"
                                                 TextWrapping="Wrap"
                                                 Tag="没有翻译结果"
                                                 Text="{Binding TranslatedText}"
                                                 FontSize="14"
                                                 IsEnabled="False" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </TabItem>
            </TabControl>
        </ScrollViewer>
    </Grid>
</local:BasePage>